try to overhaul this function because is super over extra ultra complicated